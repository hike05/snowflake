{ config, pkgs, lib, ... }:

{
  programs.zsh = {
    enable = true;
    enableCompletion = true;
    autosuggestion.enable = true;
    syntaxHighlighting.enable = true;
    
    # History configuration
    history = {
      size = 100000;
      save = 100000;
      path = "${config.xdg.dataHome}/zsh/history";
      ignoreDups = true;
      ignoreSpace = true;
      share = true;
    };
    
    # Shell aliases
    shellAliases = {
      # Navigation
      ".." = "cd ..";
      "..." = "cd ../..";
      "...." = "cd ../../..";
      
      # Modern replacements
      ls = "eza --icons --group-directories-first";
      ll = "eza --icons --group-directories-first -la";
      lt = "eza --icons --group-directories-first --tree";
      cat = "bat";
      grep = "rg";
      find = "fd";
      vim = "nvim";
      top = "btop";
      
      # Git shortcuts
      g = "git";
      gs = "git status";
      ga = "git add";
      gc = "git commit";
      gp = "git push";
      gl = "git pull";
      gco = "git checkout";
      gb = "git branch";
      
      # Nix commands
      rebuild = "darwin-rebuild switch --flake ~/dotfiles";
      update = "cd ~/dotfiles && nix flake update && rebuild";
      rollback = "darwin-rebuild rollback";
      clean = "nix-collect-garbage -d";
      search = "nix search nixpkgs";
    };
    
    # Oh My Zsh
    oh-my-zsh = {
      enable = true;
      theme = "robbyrussell";
      plugins = [
        "git"
        "docker"
        "kubectl"
        "aws"
        "fzf"
        "z"
      ];
    };
    
    # Additional init
    initExtra = ''
      # Add Homebrew to PATH
      export PATH="/opt/homebrew/bin:$PATH"
      export PATH="$HOME/.local/bin:$PATH"
      
      # Initialize zoxide
      eval "$(zoxide init zsh)"
    '';
  };

  # Starship prompt (alternative to Oh My Zsh theme)
  programs.starship = {
    enable = false;  # Set to true if you prefer starship
    enableZshIntegration = true;
    settings = {
      format = lib.concatStrings [
        "$username"
        "$hostname"
        "$directory"
        "$git_branch"
        "$git_state"
        "$git_status"
        "$cmd_duration"
        "$line_break"
        "$character"
      ];
      
      directory = {
        style = "blue bold";
        truncation_length = 4;
        truncate_to_repo = false;
      };
      
      character = {
        success_symbol = "[❯](purple)";
        error_symbol = "[❯](red)";
        vimcmd_symbol = "[❮](green)";
      };
    };
  };

  # Directory environment switcher
  programs.direnv = {
    enable = true;
    enableZshIntegration = true;
    nix-direnv.enable = true;
  };

  # Fuzzy finder
  programs.fzf = {
    enable = true;
    enableZshIntegration = true;
    defaultCommand = "fd --type f --hidden --follow --exclude .git";
    defaultOptions = [
      "--height 40%"
      "--layout=reverse"
      "--border"
      "--inline-info"
    ];
  };

  # Terminal multiplexer
  programs.tmux = {
    enable = true;
    baseIndex = 1;
    clock24 = true;
    keyMode = "vi";
    shortcut = "a";
    terminal = "screen-256color";
    
    extraConfig = ''
      # Enable mouse
      set -g mouse on
      
      # Fast escape
      set -sg escape-time 0
      
      # Increase history
      set -g history-limit 10000
      
      # Status bar
      set -g status-style bg=black,fg=white
      set -g status-left "#S "
      set -g status-right "%H:%M %d-%b-%y"
    '';
  };
}